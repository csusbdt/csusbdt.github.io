<html>
<head>
<title>Home</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<style>
#g_content {
  display: flow;
  flex-direction: column;
  align-items: stretch;
}
#g_inputs {
  display: grid;
  grid-gap: 10px;
  grid-template-columns: [label] auto [input] 1fr;        
}
input {
  grid-column: input;
  align-self: center;
}
label {
  grid-column: label;
  align-self: center;
}
td {
    width: 50%;
}
</style>
</head>
<body>

<div id="g_content">
<table>
    <tr><td>time_zone_offset</td><td><input id="g_time_zone_offset"></input></td></tr>
    <tr><td>latitude </td><td><input id="g_lat"></input></td></tr>
    <tr><td>longitude</td><td><input id="g_long"></input></td></tr>
</table>
<hr>

<div id="g_local_time"></div>
<div id="g_time"></div>

<script src="suncalc.js" type="module"></script> <!-- https://github.com/mourner/suncalc -->

<script type="module">
  function pad(num) {
    return num.toString().padStart(2, '0');
  }

  function hhmm(milliseconds) {
    let seconds = Math.floor(milliseconds / 1000);
    let minutes = Math.floor(seconds / 60);
    let hours = Math.floor(minutes / 60);
    seconds = seconds % 60;
    minutes = seconds >= 30 ? minutes + 1 : minutes;
    minutes = minutes % 60;
    return `${hours}h${minutes}`;
  }
  
  const hrs24    = 24 * 60 * 60 * 1000;
  let lat        = 0; //34.1083;
  let long       = 0; //-117.2898;
  let local_time = new Date();

  function update() {
    lat  = g_lat.value; //              = lat;
    long = g_long.value; //             = long;
    let s = "";
    if (local_time.getHours() <= 12) {
      s += local_time.getHours() + ":";
    } else {
      s += (local_time.getHours() - 12) + ":";
    }
    if (local_time.getMinutes() < 10) s += "0";
    s += local_time.getMinutes();
    if (local_time.getHours() < 12) {
      s += " am"; 
    } else {
      s += " pm";
    }
    
    g_local_time.innerHTML   = s;
    g_time_zone_offset.value = local_time.getTimezoneOffset() / 60;

    const sun_today     = SunCalc.getTimes(local_time, lat, long);
    //g_sunrise.innerHTML = sun_today.sunrise.getHours() + ':' + sun_today.sunrise.getMinutes() + ' am';
    //g_sunset.innerHTML  = (sun_today.sunset.getHours() - 12) + ':' + sun_today.sunset.getMinutes() + ' pm';

    const sunrise    = sun_today.sunrise.getTime();
    const sunset     = sun_today.sunset.getTime();
    const now        = local_time.getTime();

    if (now < sunrise) {
      g_time.innerHTML = hhmm(sunrise - now) + " sunrise";
    } else if (now < sunset) {
      g_time.innerHTML = hhmm(sunset - now) + " sunset";        
    } else {
      const tomorrow_sunrise = SunCalc.getTimes(now + hrs24, lat, long).sunrise.getTime();
      g_time.innerHTML = hhmm(tomorrow_sunrise - now) + " sunrise";        
    }
      
  }
  g_lat             .addEventListener('change', update);
  g_long            .addEventListener('change', update);
  g_time_zone_offset.addEventListener('change', update);
  
  function success(position) {
    g_lat.value  = position.coords.latitude;
    g_long.value = position.coords.longitude;
    update();
  }

  function error() {
    g_lat.value  = 34.1083;
    g_long.value = -117.2898;      
    update();
  }

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(success, error);
  } else {
    error();
  }

  update();
  setTimeout(update, 60 * 1000);

</script>
    
</body>
</html>
